<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FFA Food Drive Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .user-marker {
      position: relative;
      width: 40px;   /* doubled from 20px */
      height: 40px;  /* doubled from 20px */
    }
    .user-rotate {
      width: 100%;
      height: 100%;
      transform-origin: 50% 50%; /* still rotate around center */
    }
    .user-dot {
      width: 20px;    /* doubled from 10px */
      height: 20px;   /* doubled from 10px */
      background: blue;
      border-radius: 50%;
      position: absolute;
      top: 10px;      /* doubled from 5px */
      left: 10px;     /* doubled from 5px */
      z-index: 2;
    }
    .user-arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;   /* doubled from 5px */
      border-right: 10px solid transparent;  /* doubled from 5px */
      border-bottom: 16px solid blue;        /* doubled from 8px */
      position: absolute;
      top: -16px;   /* doubled from -8px */
      left: 10px;   /* doubled from 5px */
      transform-origin: 50% 100%;
      z-index: 1;
    }
    .leaflet-control-layers {
      font-size: 30px; /* increase text size */
      padding: 6px 10px; /* increase padding */
    }
    .leaflet-control-layers label {
      font-size: 30px; /* increase checkbox label size */
    }
  </style>
</head>
<body>
  <div id="green-counter" style="
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      font-size: 30px;
  ">Green markers: 0</div>
  <div id="map"></div>
  <button id="return-btn" style="
    position: absolute;
    bottom: 180px;
    right: 10px;
    z-index: 1000;
    padding: 15px 30px;       /* 6*2.5 = 15, 12*2.5 = 30 */
    border-radius: 20px;      /* optional: scale slightly for proportion */
    background: white;
    font-weight: bold;
    font-size: 2rem;        /* scales text 2.5× */
    cursor: pointer;
  ">↗</button>

  <button id="reset-btn" style="
      position: absolute;
      bottom: 100px;
      right: 10px;
      z-index: 1000;
      padding: 15px 30px;
      border-radius: 20px;
      background: white;
      font-weight: bold;
      font-size: 2rem;
      cursor: pointer;
    ">Reset</button>

  <button id="undo-btn" style="
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      padding: 15px 30px;
      border-radius: 20px;
      background: white;
      font-weight: bold;
      font-size: 2rem;
      cursor: pointer;
    ">Undo Remove</button>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const socket = io();
    let removedHouses = [];

    // Map layers
    const streets = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
      {
        attribution: 'Tiles © Esri & contributors',
        maxZoom: 22,        // allow zooming further
        maxNativeZoom: 19   // Esri tiles only go to ~19
      }
    );

    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        attribution: 'Tiles © Esri',
        maxZoom: 22,
        maxNativeZoom: 19   // World Imagery usually goes to ~19 or 20
      }
    );

    const map = L.map('map', {
      center: [37.8, -96],
      zoom: 14,
      layers: [streets],
      zoomSnap: 0.25,   // allow fractional zooms
      zoomDelta: 0.25,  // smaller zoom steps
      minZoom: 1,
      maxZoom: 22
    });
    L.control.layers({ "Streets": streets, "Satellite": satellite }).addTo(map);

    const markers = {};

    function updateUndoButton() {
      if (removedHouses.length === 0) {
        undoBtn.disabled = true;        // disable button
        undoBtn.style.background = "#ccc"; // gray background
        undoBtn.style.cursor = "not-allowed";
      } else {
        undoBtn.disabled = false;
        undoBtn.style.background = "white"; // normal color
        undoBtn.style.cursor = "pointer";
      }
    }

    const userIcon = L.divIcon({
      className: "user-marker",
      html: `
        <div class="user-rotate">
          <div class="user-dot"></div>
          <div class="user-arrow"></div>
        </div>
      `,
      iconSize: [40, 40],      // doubled from 20×20
      iconAnchor: [20, 20]     // keep centered
    });

    // Add user marker
    let userMarker = null;
    let currentHeading = 0;

    function addUserLocation(latlng) {
      if (!userMarker) {
        userMarker = L.marker(latlng, { icon: userIcon }).addTo(map);
      } else {
        userMarker.setLatLng(latlng);
      }

      const rotateEl = userMarker.getElement().querySelector(".user-rotate");
      if (rotateEl) {
        rotateEl.style.transform = `rotate(${currentHeading}deg)`;
      }
    }

    window.addEventListener("deviceorientationabsolute", e => {
      if (userMarker && e.alpha !== null) {
        currentHeading = -e.alpha;
        const rotateEl = userMarker.getElement().querySelector(".user-rotate");
        if (rotateEl) {
          rotateEl.style.transform = `rotate(${currentHeading}deg)`;
        }
      }
    });

    function zoomToLocation(map, lat, lng, zoomLevel = 18) {
      const latlng = [lat, lng];
      map.setView(latlng, zoomLevel);
    }

    let firstUpdate = true;

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        addUserLocation({ lat: latlng[0], lng: latlng[1] });

        if (firstUpdate) {
          map.setView(latlng, 18); // only the first time
          firstUpdate = false;
        }
      },
      err => console.warn("Geolocation failed:", err.message),
      {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }

    const HOUSE_TOLERANCE = 10;

    map.on("click", e => {
      const clickLatLng = e.latlng;
    
      let tooClose = false;
      let blockingHouse = null;
    
      // Check each existing marker
      Object.entries(markers).forEach(([house_id, marker]) => {
        const markerLatLng = marker.getLatLng();
        const dist = clickLatLng.distanceTo(markerLatLng);
        if (dist < HOUSE_TOLERANCE) {
          tooClose = true;
          blockingHouse = {
            house_id,
            lat: markerLatLng.lat,
            lng: markerLatLng.lng
          };
        }
      });
    
      if (!tooClose) {
        // Add new marker locally
        const house_id = `${clickLatLng.lat.toFixed(5)},${clickLatLng.lng.toFixed(5)}`;
        
        const newMarker = L.circleMarker([clickLatLng.lat, clickLatLng.lng], {
          radius: 8,
          fillColor: "green",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map);
    
        markers[house_id] = newMarker;
    
        // Send add event to server
        socket.emit("add_house", {
          house_id,
          lat: clickLatLng.lat,
          lng: clickLatLng.lng
        });
      } else if (blockingHouse) {
        // Remove marker locally first
        const markerToRemove = markers[blockingHouse.house_id];
        if (markerToRemove) {
          map.removeLayer(markerToRemove);
          delete markers[blockingHouse.house_id];
        }
    
        // Track removed houses for undo
        removedHouses.push(blockingHouse);
        updateUndoButton();
    
        // Send remove event to server
        socket.emit("remove_house", {
          house_id: blockingHouse.house_id,
          lat: blockingHouse.lat,
          lng: blockingHouse.lng
        });
      }
      // Update counter
      const greenCount = Object.keys(markers).length;
      document.getElementById("green-counter").textContent = `Houses Visited: ${greenCount}`;
    });

    socket.on("update_houses", houses => {
      const currentHouseIds = new Set(Object.keys(houses));

      // Remove markers that no longer exist
      Object.keys(markers).forEach(house_id => {
        if (!currentHouseIds.has(house_id)) {
          map.removeLayer(markers[house_id]);
          delete markers[house_id];
        }
      });

      // Add markers for current houses
      Object.entries(houses).forEach(([house_id, data]) => {
        if (!house_id || house_id === "None") return;

        let marker = markers[house_id];
        const { lat, lng } = data;

        if (!marker) {
          marker = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: "green",   // always green
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);

          marker.on("click", () => {
            socket.emit("house_house", { house_id, lat, lng });
          });

          markers[house_id] = marker;
        }
      });

      // Update counter
      const greenCount = Object.keys(houses).length;
      document.getElementById("green-counter").textContent = `Houses Visited: ${greenCount}`;
    });

    const zoomButton = document.getElementById('return-btn');
    zoomButton.onclick = () => {
        if (userMarker) {
            const latlng = userMarker.getLatLng();
            zoomToLocation(map, latlng.lat, latlng.lng, 18);
        }
    };

    const resetBtn = document.getElementById("reset-btn");

    resetBtn.addEventListener("click", () => {
      const password = prompt("Enter password to reset:");

      // Replace 'yourPassword' with your actual password
      if (password === "9999") {
        socket.emit("reset_houses"); // Emit the event to the server
      }
    });

    const undoBtn = document.getElementById("undo-btn");

    undoBtn.addEventListener("click", () => {
      let removed = removedHouses.pop();
      socket.emit("add_house", removed);
      updateUndoButton();
    });
    updateUndoButton();
    </script>
</body>
</html>


